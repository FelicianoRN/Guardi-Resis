<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión de Guardias - Residentes R2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f9fafb;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 20px;
            max-width: none;
        }
        
        .calendar-day {
            min-height: 320px;
            border: 2px solid #d1d5db;
            border-radius: 16px;
            padding: 20px;
            background: linear-gradient(to bottom, white, #f9fafb);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
            transform: translateY(-3px);
        }
        
        .day-header {
            font-weight: bold;
            font-size: 22px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .day-info {
            display: flex;
            flex-direction: column;
        }
        
        .day-number {
            color: #374151;
            font-size: 28px;
            font-weight: 800;
        }
        
        .day-name {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            padding: 8px 14px;
            border-radius: 8px;
            margin-top: 6px;
            text-align: center;
            border: 1px solid #d1d5db;
        }
        
        .day-badges {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }
        
        .badge-fds {
            font-size: 12px;
            background: #fcd34d;
            color: #92400e;
            padding: 8px 12px;
            border-radius: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .badge-prefestivo {
            font-size: 12px;
            background: #dc2626;
            color: white;
            padding: 8px 12px;
            border-radius: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
        }
        
        .j-button {
            font-size: 12px;
            padding: 10px 16px;
            border-radius: 18px;
            cursor: pointer;
            font-weight: bold;
            border: 2px solid;
            transition: all 0.2s ease;
            background: none;
            outline: none;
        }
        
        .j-button:hover {
            transform: scale(1.05);
        }
        
        .j-button.active {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
        }
        
        .j-button.active:hover {
            background: #dc2626;
        }
        
        .j-button.inactive {
            background: #9ca3af;
            color: white;
            border-color: #6b7280;
        }
        
        .j-button.inactive:hover {
            background: #6b7280;
        }
        
        .specialty-section {
            margin-bottom: 14px;
        }
        
        .specialty-header {
            font-size: 13px;
            padding: 8px 14px;
            border-radius: 10px;
            font-weight: bold;
            margin-bottom: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .guard-item {
            background: #f3f4f6;
            padding: 8px 14px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            border: 1px solid #e5e7eb;
            margin-bottom: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        
        .guard-item:hover {
            background: #e5e7eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .guard-name {
            font-weight: 600;
            color: #374151;
        }
        
        .remove-btn {
            color: #ef4444;
            cursor: pointer;
            font-weight: bold;
            padding: 6px 10px;
            border-radius: 50%;
            transition: all 0.2s ease;
            background: none;
            border: none;
            font-size: 16px;
        }
        
        .remove-btn:hover {
            background: #fee2e2;
            color: #dc2626;
            transform: scale(1.2);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            margin: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .custom-table {
            width: 100%;
            font-size: 14px;
            border-collapse: collapse;
            background: white;
        }
        
        .custom-table th,
        .custom-table td {
            border: 1px solid #d1d5db;
            padding: 12px;
            text-align: center;
        }
        
        .custom-table th {
            background: #f8fafc;
            font-weight: bold;
            color: #374151;
        }
        
        .custom-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .resident-name {
            text-align: left !important;
            font-weight: bold;
            background: #f9fafb !important;
        }
        
        .total-cell {
            background: #dbeafe !important;
            color: #1e40af !important;
            font-weight: bold;
            font-size: 18px;
        }
        
        .weekend-cell {
            background: #fef3c7 !important;
            color: #92400e !important;
            font-weight: bold;
            font-size: 18px;
        }
        
        .specialty-ura { background: #f3e8ff !important; }
        .specialty-pedia { background: #fee2e2 !important; }
        .specialty-trauma { background: #fed7aa !important; }
        .specialty-psiquia { background: #dbeafe !important; }
        .specialty-gine { background: #fce7f3 !important; }
        
        .weekend-day { background: #fef3c7 !important; color: #92400e !important; }
        .normal-day { background: #f0f9ff !important; }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        
        .card-header {
            padding: 24px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .card-content {
            padding: 24px;
        }
        
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover {
            background: #2563eb;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .form-select {
            width: 100%;
            border: 2px solid #d1d5db;
            border-radius: 10px;
            padding: 14px 16px;
            transition: all 0.2s ease;
            background: white;
            font-size: 14px;
            font-weight: 500;
        }
        
        .form-select:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #374151;
        }
        
        #app {
            max-width: 95vw;
            margin: 0 auto;
            padding: 24px;
        }
        
        .icon-calendar::before { content: "📅"; }
        .icon-plus::before { content: "➕"; }
        .icon-refresh::before { content: "🔄"; }
        .icon-trophy::before { content: "🏆"; }
        .icon-warning::before { content: "⚠️"; }
        .icon-info::before { content: "ℹ️"; }
        .icon-hospital::before { content: "🏥"; }
        .icon-star::before { content: "⭐"; }
        
        @media (max-width: 1200px) {
            .calendar-day {
                min-height: 280px;
                padding: 16px;
            }
            
            .day-number {
                font-size: 24px;
            }
        }
        
        @media (max-width: 768px) {
            .calendar-grid {
                gap: 12px;
            }
            
            .calendar-day {
                min-height: 240px;
                padding: 12px;
            }
            
            .day-number {
                font-size: 20px;
            }
            
            #app {
                padding: 16px;
                max-width: 100vw;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="bg-gray-50 min-h-screen">
        <!-- La aplicación se cargará aquí -->
    </div>

    <script>
        // Datos base
        const residentes = {
            'ÁLVARO PACHECO': 'PACHE',
            'ANA MARTIN MUELA': 'ANEKA',
            'BLANCA URBIZU': 'BLANCH',
            'ELENA SACRISTAN': 'ELENA',
            'ENRIQUE GALLEGO': 'KIKE',
            'MARIA ALICIA POSSE': 'ALI',
            'MARIA GOMEZ CAMPO': 'MARÍA',
            'MARÍA GÓMEZ JORGE': 'MER',
            'MARTA RUS': 'MARTA',
            'NOELIA MEDINA': 'NOE',
            'SARA MORALES': 'SARA',
            'SONIA GONZALEZ': 'SONIA'
        };

        const nombresCompletos = Object.keys(residentes);

        const especialidades = {
            'URA': { nombre: 'Urgencias', color: 'bg-purple-300 text-purple-800' },
            'PEDIA': { nombre: 'Pediatría', color: 'bg-red-300 text-red-800' },
            'TRAUMA': { nombre: 'Traumatología', color: 'bg-orange-300 text-orange-800' },
            'PSIQUIA': { nombre: 'Psiquiatría', color: 'bg-blue-300 text-blue-800' },
            'GINE': { nombre: 'Ginecología', color: 'bg-pink-300 text-pink-800' }
        };

        const dias = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                      'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

        // Estado de la aplicación
        let estado = {
            mesActual: 0,
            añoActual: 2025,
            diaSeleccionado: 1,
            especialidadSeleccionada: 'URA',
            residenteSeleccionado: nombresCompletos[0],
            mostrarModalReinicio: false,
            guardiasPorMes: {},
            viernesEspeciales: {},
            contadoresTotales: {}
        };

        // Inicializar contadores
        function inicializarContadores() {
            const inicial = {};
            nombresCompletos.forEach(nombre => {
                inicial[nombre] = {
                    URA: 0, PEDIA: 0, TRAUMA: 0, PSIQUIA: 0, GINE: 0,
                    finDeSemana: 0, total: 0,
                    porDia: { Lunes: 0, Martes: 0, Miércoles: 0, Jueves: 0, Viernes: 0, Sábado: 0, Domingo: 0 }
                };
            });
            return inicial;
        }

        // Cargar datos del localStorage
        function cargarDatos() {
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    const guardias = localStorage.getItem('guardias-por-mes-2025');
                    const viernes = localStorage.getItem('viernes-especiales-2025');
                    const contadores = localStorage.getItem('contadores-totales-2025');
                    
                    estado.guardiasPorMes = guardias ? JSON.parse(guardias) : {};
                    estado.viernesEspeciales = viernes ? JSON.parse(viernes) : {};
                    estado.contadoresTotales = contadores ? JSON.parse(contadores) : inicializarContadores();
                } else {
                    console.warn('localStorage no disponible, usando valores por defecto');
                    estado.guardiasPorMes = {};
                    estado.viernesEspeciales = {};
                    estado.contadoresTotales = inicializarContadores();
                }
            } catch (e) {
                console.warn('Error al cargar datos:', e);
                estado.guardiasPorMes = {};
                estado.viernesEspeciales = {};
                estado.contadoresTotales = inicializarContadores();
            }
        }

        // Guardar datos en localStorage
        function guardarDatos() {
            try {
                if (typeof(Storage) !== "undefined" && localStorage) {
                    localStorage.setItem('guardias-por-mes-2025', JSON.stringify(estado.guardiasPorMes));
                    localStorage.setItem('viernes-especiales-2025', JSON.stringify(estado.viernesEspeciales));
                    localStorage.setItem('contadores-totales-2025', JSON.stringify(estado.contadoresTotales));
                }
            } catch (e) {
                console.warn('Error al guardar datos:', e);
            }
        }

        // Utilidades
        function getDiasDelMes(mes, año) {
            return new Date(año, mes + 1, 0).getDate();
        }

        function getDiaDeLaSemana(dia, mes, año) {
            return new Date(año, mes, dia).getDay();
        }

        function esFinDeSemana(dia, mes, año) {
            const diaSemana = getDiaDeLaSemana(dia, mes, año);
            return diaSemana === 0 || diaSemana === 5 || diaSemana === 6;
        }

        function esViernesEspecial(dia, mes, año) {
            const clave = `${año}-${mes}-${dia}`;
            return estado.viernesEspeciales[clave] === true;
        }

        function getGuardiasDelMes() {
            return estado.guardiasPorMes[`${estado.añoActual}-${estado.mesActual}`] || {};
        }

        // Funciones principales
        function marcarJuevesFestivo(dia) {
            const clave = `${estado.añoActual}-${estado.mesActual}-${dia}`;
            
            if (estado.viernesEspeciales[clave]) {
                delete estado.viernesEspeciales[clave];
            } else {
                estado.viernesEspeciales[clave] = true;
            }

            // Recalcular contadores existentes
            const guardias = getGuardiasDelMes();
            const guardiasDelDia = guardias[dia];
            
            if (guardiasDelDia) {
                Object.entries(guardiasDelDia).forEach(([especialidad, residentes]) => {
                    residentes.forEach(residente => {
                        const seEstaActivando = estado.viernesEspeciales[clave];
                        if (seEstaActivando) {
                            estado.contadoresTotales[residente].porDia.Jueves -= 1;
                            estado.contadoresTotales[residente].porDia.Viernes += 1;
                            estado.contadoresTotales[residente].finDeSemana += 1;
                        } else {
                            estado.contadoresTotales[residente].porDia.Viernes -= 1;
                            estado.contadoresTotales[residente].porDia.Jueves += 1;
                            estado.contadoresTotales[residente].finDeSemana -= 1;
                        }
                    });
                });
            }

            guardarDatos();
            renderizar();
        }

        function agregarGuardia(dia, especialidad, nombreCompleto) {
            const keyMes = `${estado.añoActual}-${estado.mesActual}`;
            
            if (!estado.guardiasPorMes[keyMes]) estado.guardiasPorMes[keyMes] = {};
            if (!estado.guardiasPorMes[keyMes][dia]) estado.guardiasPorMes[keyMes][dia] = {};
            if (!estado.guardiasPorMes[keyMes][dia][especialidad]) estado.guardiasPorMes[keyMes][dia][especialidad] = [];
            
            if (!estado.guardiasPorMes[keyMes][dia][especialidad].includes(nombreCompleto)) {
                estado.guardiasPorMes[keyMes][dia][especialidad].push(nombreCompleto);
                actualizarContadores(nombreCompleto, especialidad, dia, 'agregar');
                guardarDatos();
                renderizar();
            }
        }

        function quitarGuardia(dia, especialidad, nombreCompleto) {
            const keyMes = `${estado.añoActual}-${estado.mesActual}`;
            
            if (estado.guardiasPorMes[keyMes]?.[dia]?.[especialidad]) {
                estado.guardiasPorMes[keyMes][dia][especialidad] = 
                    estado.guardiasPorMes[keyMes][dia][especialidad].filter(r => r !== nombreCompleto);
                actualizarContadores(nombreCompleto, especialidad, dia, 'quitar');
                guardarDatos();
                renderizar();
            }
        }

        function actualizarContadores(nombreCompleto, especialidad, dia, accion) {
            const incremento = accion === 'agregar' ? 1 : -1;
            const diaSemanaIndex = getDiaDeLaSemana(dia, estado.mesActual, estado.añoActual);
            let diaSemana = diaSemanaIndex === 0 ? 'Domingo' : dias[diaSemanaIndex - 1];
            
            // Si es jueves festivo, contar como viernes
            if (diaSemanaIndex === 4 && esViernesEspecial(dia, estado.mesActual, estado.añoActual)) {
                diaSemana = 'Viernes';
            }
            
            estado.contadoresTotales[nombreCompleto][especialidad] += incremento;
            estado.contadoresTotales[nombreCompleto].total += incremento;
            estado.contadoresTotales[nombreCompleto].porDia[diaSemana] += incremento;
            
            if (esFinDeSemana(dia, estado.mesActual, estado.añoActual) || 
                (diaSemanaIndex === 4 && esViernesEspecial(dia, estado.mesActual, estado.añoActual))) {
                estado.contadoresTotales[nombreCompleto].finDeSemana += incremento;
            }
        }

        function reiniciarTodo() {
            estado.contadoresTotales = inicializarContadores();
            estado.guardiasPorMes = {};
            estado.viernesEspeciales = {};
            localStorage.clear();
            estado.mostrarModalReinicio = false;
            renderizar();
        }

        // Funciones de exportar/importar datos
        function exportarDatos() {
            const datos = {
                guardiasPorMes: estado.guardiasPorMes,
                viernesEspeciales: estado.viernesEspeciales,
                contadoresTotales: estado.contadoresTotales,
                fechaExportacion: new Date().toISOString(),
                version: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `guardias-datos-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('✅ Datos exportados correctamente');
        }

        function importarDatos(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const datos = JSON.parse(e.target.result);
                    
                    if (datos.guardiasPorMes && datos.contadoresTotales) {
                        estado.guardiasPorMes = datos.guardiasPorMes;
                        estado.viernesEspeciales = datos.viernesEspeciales || {};
                        estado.contadoresTotales = datos.contadoresTotales;
                        
                        guardarDatos();
                        renderizar();
                        alert('✅ Datos importados correctamente');
                    } else {
                        alert('❌ El archivo no tiene el formato correcto');
                    }
                } catch (error) {
                    alert('❌ Error al leer el archivo: ' + error.message);
                }
                
                // Limpiar el input
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function generarHTMLConDatos() {
            const datos = {
                guardiasPorMes: estado.guardiasPorMes,
                viernesEspeciales: estado.viernesEspeciales,
                contadoresTotales: estado.contadoresTotales
            };
            
            // Obtener el HTML actual completo
            let htmlCompleto = document.documentElement.outerHTML;
            
            // Crear un HTML con datos pre-cargados
            const htmlConDatos = htmlCompleto.replace(
                'cargarDatos();',
                `
                // DATOS PRE-CARGADOS
                const DATOS_PRECARGADOS = ${JSON.stringify(datos, null, 8)};
                
                // Cargar datos pre-cargados
                if (DATOS_PRECARGADOS && Object.keys(DATOS_PRECARGADOS.guardiasPorMes || {}).length > 0) {
                    estado.guardiasPorMes = DATOS_PRECARGADOS.guardiasPorMes;
                    estado.viernesEspeciales = DATOS_PRECARGADOS.viernesEspeciales;
                    estado.contadoresTotales = DATOS_PRECARGADOS.contadoresTotales;
                    console.log('✅ Datos pre-cargados aplicados correctamente');
                } else {
                    cargarDatos();
                }
                `
            );
            
            const blob = new Blob([htmlConDatos], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sistema-guardias-COMPLETO-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('✅ HTML completo con datos generado correctamente!\nEste archivo contiene toda la aplicación + tus datos');
        }

        // Funciones de renderizado
        function renderizar() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${renderHeader()}
                ${renderPanelAsignacion()}
                ${renderCalendario()}
                ${renderTotales()}
                ${estado.mostrarModalReinicio ? renderModal() : ''}
            `;
        }

        function renderHeader() {
            const totalGuardias = Object.values(estado.contadoresTotales).reduce((sum, contador) => sum + contador.total, 0);
            const juevesFestivos = Object.keys(estado.viernesEspeciales)
                .filter(key => key.startsWith(`${estado.añoActual}-${estado.mesActual}-`)).length;

            return `
                <div class="mb-8">
                    <div class="text-center mb-8">
                        <h1 class="text-5xl font-bold text-gray-800 mb-3">
                            Sistema de Gestión de Guardias
                        </h1>
                        <h2 class="text-3xl font-semibold text-blue-600 mb-2">Residentes R2</h2>
                        <p class="text-gray-600 text-xl">Año 2025 - Gestión completa con contadores automáticos</p>
                    </div>
                    
                    <div class="card mb-6">
                        <div class="card-content">
                            <div class="flex flex-col lg:flex-row items-center justify-between gap-6">
                                <div class="flex items-center gap-6">
                                    <div class="flex items-center gap-4">
                                        <span class="icon-calendar text-2xl text-blue-500"></span>
                                        <span class="text-lg font-semibold text-gray-700">Seleccionar Mes</span>
                                        <select onchange="cambiarMes(this.value)" class="form-select bg-white border-2 border-gray-300 text-lg font-semibold" style="width: 180px; padding: 10px 14px;">
                                            ${meses.map((mes, index) => 
                                                `<option value="${index}" ${index === estado.mesActual ? 'selected' : ''}>${mes} 2025</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-4">
                                    <button onclick="exportarDatos()" class="btn btn-primary" style="padding: 12px 24px; font-size: 16px; font-weight: 700;">
                                        📤 Exportar Datos
                                    </button>
                                    <button onclick="document.getElementById('importFile').click()" class="btn btn-secondary" style="padding: 12px 24px; font-size: 16px; font-weight: 700;">
                                        📥 Importar Datos
                                    </button>
                                    <button onclick="generarHTMLConDatos()" class="btn" style="padding: 12px 24px; font-size: 16px; font-weight: 700; background: #10b981; color: white;">
                                        🌐 HTML con Datos
                                    </button>
                                    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importarDatos(event)">
                                    <button onclick="abrirModalReinicio()" class="btn btn-danger" style="padding: 12px 24px; font-size: 16px; font-weight: 700;">
                                        <span class="icon-refresh"></span>
                                        Reiniciar Todo
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-6">
                        <div class="card-content">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">🏥 Especialidades Médicas</h3>
                            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                                ${Object.entries(especialidades).map(([esp, info]) => `
                                    <div class="relative overflow-hidden rounded-xl border-2 border-gray-200 shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                                        <div class="${info.color} p-6 text-center">
                                            <div class="text-2xl font-black mb-2">${esp}</div>
                                            <div class="text-sm font-semibold opacity-90">${info.nombre}</div>
                                        </div>
                                        <div class="absolute top-0 right-0 w-6 h-6 bg-white bg-opacity-30 rounded-bl-lg"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <div class="card mb-6">
                        <div class="card-content">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">📋 Leyenda de Marcadores</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-gradient-to-br from-yellow-100 to-yellow-200 p-6 rounded-xl border-2 border-yellow-300 shadow-lg">
                                    <div class="flex items-center justify-center gap-3">
                                        <div class="w-6 h-6 bg-yellow-400 rounded-full shadow-md"></div>
                                        <span class="text-lg font-bold text-yellow-800">FDS</span>
                                    </div>
                                    <div class="text-center mt-2 text-yellow-700 font-semibold">Fin de Semana</div>
                                </div>
                                <div class="bg-gradient-to-br from-orange-100 to-orange-200 p-6 rounded-xl border-2 border-orange-300 shadow-lg">
                                    <div class="flex items-center justify-center gap-3">
                                        <div class="w-6 h-6 bg-orange-400 rounded-full shadow-md"></div>
                                        <span class="text-lg font-bold text-orange-800">J*</span>
                                    </div>
                                    <div class="text-center mt-2 text-orange-700 font-semibold">Jueves Prefestivo</div>
                                </div>
                                <div class="bg-gradient-to-br from-red-100 to-red-200 p-6 rounded-xl border-2 border-red-300 shadow-lg">
                                    <div class="flex items-center justify-center gap-3">
                                        <div class="w-6 h-6 bg-red-500 rounded-full shadow-md"></div>
                                        <span class="text-lg font-bold text-red-800">PREFESTIVO</span>
                                    </div>
                                    <div class="text-center mt-2 text-red-700 font-semibold">Cuenta como Viernes</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-content">
                            <h4 class="text-2xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center gap-3">
                                <span class="icon-info text-blue-500"></span>
                                Estado Actual del Sistema
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border-2 border-blue-200 shadow-lg">
                                    <div class="text-center">
                                        <span class="icon-calendar text-4xl text-blue-500 block mb-3"></span>
                                        <div class="text-sm font-semibold text-blue-700 mb-1">Mes Seleccionado</div>
                                        <div class="text-2xl font-bold text-blue-800">${meses[estado.mesActual]}</div>
                                        <div class="text-lg font-semibold text-blue-600">2025</div>
                                    </div>
                                </div>
                                <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl border-2 border-orange-200 shadow-lg">
                                    <div class="text-center">
                                        <span class="icon-star text-4xl text-orange-500 block mb-3"></span>
                                        <div class="text-sm font-semibold text-orange-700 mb-1">Jueves Prefestivos</div>
                                        <div class="text-3xl font-bold text-orange-800">${juevesFestivos}</div>
                                        <div class="text-sm text-orange-600">Este mes</div>
                                    </div>
                                </div>
                                <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border-2 border-green-200 shadow-lg">
                                    <div class="text-center">
                                        <span class="icon-hospital text-4xl text-green-500 block mb-3"></span>
                                        <div class="text-sm font-semibold text-green-700 mb-1">Total Guardias</div>
                                        <div class="text-3xl font-bold text-green-800">${totalGuardias}</div>
                                        <div class="text-sm text-green-600">Año completo</div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 p-6 bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-400 rounded-xl shadow-md">
                                <div class="flex items-start gap-4">
                                    <span class="icon-warning text-yellow-500 text-2xl mt-1"></span>
                                    <div>
                                        <div class="font-bold text-gray-800 text-lg mb-3">📌 Información Importante:</div>
                                        <ul class="text-gray-700 space-y-2">
                                            <li class="flex items-center gap-2">
                                                <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                                                Los jueves marcados como PREFESTIVO cuentan como VIERNES en los contadores
                                            </li>
                                            <li class="flex items-center gap-2">
                                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                                "Exportar Datos" descarga un archivo JSON con toda la información
                                            </li>
                                            <li class="flex items-center gap-2">
                                                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                                "HTML con Datos" crea un archivo HTML completo con los datos incluidos
                                            </li>
                                            <li class="flex items-center gap-2">
                                                <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                                                "Reiniciar Todo" borra TODOS los datos completamente (con confirmación)
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPanelAsignacion() {
            return `
                <div class="card mb-8">
                    <div class="card-content">
                        <div class="text-center mb-6">
                            <h3 class="text-3xl font-bold text-gray-800 flex items-center justify-center gap-3 mb-2">
                                <span class="icon-plus text-blue-500 text-3xl"></span>
                                Asignar Guardia
                            </h3>
                            <p class="text-gray-600 text-lg">${meses[estado.mesActual]} 2025</p>
                        </div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                                <div>
                                    <label class="form-label text-blue-700">Día del Mes</label>
                                    <select onchange="estado.diaSeleccionado = parseInt(this.value)" class="form-select bg-white border-blue-300 focus:border-blue-500">
                                        ${Array.from({ length: getDiasDelMes(estado.mesActual, estado.añoActual) }, (_, i) => i + 1)
                                            .map(dia => `
                                                <option value="${dia}" ${dia === estado.diaSeleccionado ? 'selected' : ''}>
                                                    ${dia} - ${dias[getDiaDeLaSemana(dia, estado.mesActual, estado.añoActual) === 0 ? 6 : getDiaDeLaSemana(dia, estado.mesActual, estado.añoActual) - 1]}
                                                </option>
                                            `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label text-blue-700">Especialidad</label>
                                    <select onchange="estado.especialidadSeleccionada = this.value" class="form-select bg-white border-blue-300 focus:border-blue-500">
                                        ${Object.entries(especialidades).map(([esp, info]) => `
                                            <option value="${esp}" ${esp === estado.especialidadSeleccionada ? 'selected' : ''}>
                                                ${esp} - ${info.nombre}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label text-blue-700">Residente</label>
                                    <select onchange="estado.residenteSeleccionado = this.value" class="form-select bg-white border-blue-300 focus:border-blue-500">
                                        ${nombresCompletos.map(nombre => `
                                            <option value="${nombre}" ${nombre === estado.residenteSeleccionado ? 'selected' : ''}>
                                                ${residentes[nombre]} - ${nombre}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button onclick="asignarGuardia()" 
                                            class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-3">
                                        <span class="icon-plus text-xl"></span>
                                        <span class="text-lg">Asignar Guardia</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCalendario() {
            const diasDelMes = getDiasDelMes(estado.mesActual, estado.añoActual);
            const primerDia = getDiaDeLaSemana(1, estado.mesActual, estado.añoActual);
            const guardias = getGuardiasDelMes();
            
            let html = `
                <div class="card mb-8">
                    <div class="card-content">
                        <h2 class="text-4xl font-bold mb-8 text-gray-800 text-center flex items-center justify-center gap-4">
                            <span class="icon-calendar text-4xl text-blue-500"></span>
                            Calendario - ${meses[estado.mesActual]} 2025
                        </h2>
                        
                        <div class="calendar-grid">
                            ${dias.map((dia, index) => `
                                <div class="text-center font-bold p-4 rounded-xl shadow-md border-2 ${
                                    ['Viernes', 'Sábado', 'Domingo'].includes(dia) 
                                        ? 'bg-gradient-to-br from-yellow-100 to-yellow-200 border-yellow-300 text-yellow-800' 
                                        : 'bg-gradient-to-br from-blue-100 to-blue-200 border-blue-300 text-blue-800'
                                }">
                                    <span class="text-xl font-bold">${dia}</span>
                                </div>
                            `).join('')}
            `;

            // Días vacíos al inicio
            for (let i = 0; i < (primerDia === 0 ? 6 : primerDia - 1); i++) {
                html += '<div class="calendar-day"></div>';
            }

            // Días del mes
            for (let dia = 1; dia <= diasDelMes; dia++) {
                const diaSemanaIndex = getDiaDeLaSemana(dia, estado.mesActual, estado.añoActual);
                const diaSemana = dias[diaSemanaIndex === 0 ? 6 : diaSemanaIndex - 1];
                const esJueves = diaSemanaIndex === 4;
                const esFDS = esFinDeSemana(dia, estado.mesActual, estado.añoActual);
                const esPrefestivo = esViernesEspecial(dia, estado.mesActual, estado.añoActual);

                html += `
                    <div class="calendar-day">
                        <div class="day-header">
                            <div class="day-info">
                                <span class="day-number">${dia}</span>
                                <span class="day-name">${diaSemana}</span>
                            </div>
                            <div class="day-badges">
                                ${esFDS ? '<span class="badge-fds">FDS</span>' : ''}
                                ${esPrefestivo ? '<span class="badge-prefestivo">PREFESTIVO</span>' : ''}
                                ${esJueves ? `
                                    <button onclick="marcarJuevesFestivo(${dia})" 
                                            class="j-button ${esPrefestivo ? 'active' : 'inactive'}">
                                        J*
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        <div style="space-y: 12px;">
                            ${Object.keys(especialidades).map(esp => {
                                const guardiasDia = guardias[dia]?.[esp] || [];
                                return `
                                    <div class="specialty-section">
                                        <div class="specialty-header ${especialidades[esp].color}">
                                            ${esp}
                                        </div>
                                        ${guardiasDia.map(nombreCompleto => `
                                            <div class="guard-item">
                                                <span class="guard-name">${residentes[nombreCompleto]}</span>
                                                <button class="remove-btn" onclick="quitarGuardia(${dia}, '${esp}', '${nombreCompleto}')">✕</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            html += '</div></div></div>';
            return html;
        }

        function renderTotales() {
            return `
                <div class="card">
                    <div class="card-content">
                        <h2 class="text-3xl font-bold mb-6 text-gray-800 flex items-center gap-3">
                            <span class="icon-trophy text-3xl text-yellow-500"></span>
                            Contadores Totales - Año 2025
                        </h2>
                        
                        <div class="grid md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-xl font-semibold mb-4">Por Especialidad</h3>
                                <div class="table-container">
                                    <table class="custom-table">
                                        <thead>
                                            <tr>
                                                <th class="resident-name">Residente</th>
                                                <th class="specialty-ura">URA</th>
                                                <th class="specialty-pedia">PED</th>
                                                <th class="specialty-trauma">TRA</th>
                                                <th class="specialty-psiquia">PSI</th>
                                                <th class="specialty-gine">GIN</th>
                                                <th class="total-cell">TOTAL</th>
                                                <th class="weekend-cell">DE FINDE</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${nombresCompletos.map(nombre => `
                                                <tr>
                                                    <td class="resident-name">${residentes[nombre]}</td>
                                                    <td>${estado.contadoresTotales[nombre].URA}</td>
                                                    <td>${estado.contadoresTotales[nombre].PEDIA}</td>
                                                    <td>${estado.contadoresTotales[nombre].TRAUMA}</td>
                                                    <td>${estado.contadoresTotales[nombre].PSIQUIA}</td>
                                                    <td>${estado.contadoresTotales[nombre].GINE}</td>
                                                    <td class="total-cell">${estado.contadoresTotales[nombre].total}</td>
                                                    <td class="weekend-cell">${estado.contadoresTotales[nombre].finDeSemana}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <div>
                                <h3 class="text-xl font-semibold mb-4">Por Día de la Semana</h3>
                                <div class="table-container">
                                    <table class="custom-table">
                                        <thead>
                                            <tr>
                                                <th class="resident-name">Residente</th>
                                                ${dias.map(dia => `
                                                    <th class="${['Viernes', 'Sábado', 'Domingo'].includes(dia) ? 'weekend-day' : 'normal-day'}">
                                                        ${dia.slice(0, 3)}
                                                    </th>
                                                `).join('')}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${nombresCompletos.map(nombre => `
                                                <tr>
                                                    <td class="resident-name">${residentes[nombre]}</td>
                                                    ${dias.map(dia => `
                                                        <td class="${['Viernes', 'Sábado', 'Domingo'].includes(dia) ? 'weekend-cell' : ''}">
                                                            ${estado.contadoresTotales[nombre].porDia[dia]}
                                                        </td>
                                                    `).join('')}
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderModal() {
            return `
                <div class="modal">
                    <div class="modal-content">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                            <span class="icon-warning text-red-500"></span>
                            Confirmar Reinicio
                        </h3>
                        <p class="text-gray-600 mb-6">
                            ¿Estás seguro de que quieres reiniciar todos los datos?<br>
                            <strong>Esta acción no se puede deshacer.</strong>
                        </p>
                        <div class="flex gap-3 justify-end">
                            <button onclick="cerrarModal()" class="btn btn-secondary">
                                Cancelar
                            </button>
                            <button onclick="reiniciarTodo()" class="btn btn-danger">
                                SÍ, Reiniciar Todo
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Funciones globales para eventos
        function cambiarMes(mes) {
            estado.mesActual = parseInt(mes);
            renderizar();
        }

        function asignarGuardia() {
            agregarGuardia(estado.diaSeleccionado, estado.especialidadSeleccionada, estado.residenteSeleccionado);
        }

        function abrirModalReinicio() {
            estado.mostrarModalReinicio = true;
            renderizar();
        }

        function cerrarModal() {
            estado.mostrarModalReinicio = false;
            renderizar();
        }

        // Exponer funciones al scope global
        window.cambiarMes = cambiarMes;
        window.asignarGuardia = asignarGuardia;
        window.marcarJuevesFestivo = marcarJuevesFestivo;
        window.quitarGuardia = quitarGuardia;
        window.exportarDatos = exportarDatos;
        window.importarDatos = importarDatos;
        window.generarHTMLConDatos = generarHTMLConDatos;
        window.abrirModalReinicio = abrirModalReinicio;
        window.cerrarModal = cerrarModal;
        window.reiniciarTodo = reiniciarTodo;

        // Inicializar la aplicación
        cargarDatos();
        renderizar();
    </script>
</body>
</html>